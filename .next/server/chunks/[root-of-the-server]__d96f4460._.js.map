{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 6, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 60, "column": 0}, "map": {"version":3,"sources":["file://E%3A/ASNPORTS/PELICULAS/Flick%20Verse/flick-verse/src/app/api/tv/%5Bid%5D/ratings/route.js"],"sourcesContent":["import { NextResponse } from 'next/server';\r\n\r\nconst TMDB_BASE = 'https://api.themoviedb.org/3';\r\nconst OMDB_BASE = 'https://www.omdbapi.com/';\r\n\r\nasync function tmdb(path, params = {}) {\r\n  const apiKey = process.env.NEXT_PUBLIC_TMDB_API_KEY;\r\n  if (!apiKey) throw new Error('Falta NEXT_PUBLIC_TMDB_API_KEY');\r\n  const url = new URL(`${TMDB_BASE}${path}`);\r\n  url.searchParams.set('api_key', apiKey);\r\n  url.searchParams.set('language', 'es-ES');\r\n  Object.entries(params).forEach(([k, v]) => {\r\n    if (v !== undefined && v !== null) url.searchParams.set(k, String(v));\r\n  });\r\n  const res = await fetch(url, { next: { revalidate: 120 } });\r\n  if (!res.ok) throw new Error(`TMDb ${res.status}: ${await res.text()}`);\r\n  return res.json();\r\n}\r\n\r\nasync function omdb(params = {}) {\r\n  const apiKey = process.env.OMDB_API_KEY;\r\n  if (!apiKey) throw new Error('Falta OMDB_API_KEY');\r\n  const url = new URL(OMDB_BASE);\r\n  url.searchParams.set('apikey', apiKey);\r\n  Object.entries(params).forEach(([k, v]) => {\r\n    if (v !== undefined && v !== null) url.searchParams.set(k, String(v));\r\n  });\r\n  const res = await fetch(url, { next: { revalidate: 300 } });\r\n  if (!res.ok) throw new Error(`OMDb ${res.status}: ${await res.text()}`);\r\n  return res.json();\r\n}\r\n\r\nexport async function GET(req, { params }) {\r\n  const { id } = params; // TMDb tv id\r\n  const { searchParams } = new URL(req.url);\r\n  const excludeSpecials = searchParams.get('excludeSpecials') === 'true';\r\n\r\n  try {\r\n    // 1) Detalles + external_ids para obtener imdb_id\r\n    const [details, external] = await Promise.all([\r\n      tmdb(`/tv/${id}`),\r\n      tmdb(`/tv/${id}/external_ids`),\r\n    ]);\r\n    const imdb_id = external?.imdb_id || null;\r\n\r\n    // 2) Recorrer temporadas\r\n    const seasonsMeta = Array.isArray(details.seasons) ? details.seasons : [];\r\n    const seasons = [];\r\n\r\n    for (const s of seasonsMeta) {\r\n      if (excludeSpecials && s.season_number === 0) continue;\r\n\r\n      // TMDb: episodios con vote_average y nombre\r\n      const seasonData = await tmdb(`/tv/${id}/season/${s.season_number}`);\r\n      const tmdbEpisodes = {};\r\n      for (const ep of seasonData.episodes || []) {\r\n        tmdbEpisodes[ep.episode_number] = {\r\n          name: ep.name,\r\n          tmdbRating: typeof ep.vote_average === 'number' ? ep.vote_average : null,\r\n        };\r\n      }\r\n\r\n      // IMDb vía OMDb: i=ttXXXX&Season=N\r\n      const imdbEpisodes = {};\r\n      if (imdb_id) {\r\n        try {\r\n          const om = await omdb({ i: imdb_id, Season: s.season_number });\r\n          (om?.Episodes || []).forEach(e => {\r\n            const epNum = Number(e.Episode);\r\n            const r = e.imdbRating && e.imdbRating !== 'N/A' ? Number(e.imdbRating) : null;\r\n            imdbEpisodes[epNum] = Number.isFinite(r) ? r : null;\r\n          });\r\n        } catch {\r\n          // Silenciar fallos puntuales de OMDb / límites\r\n        }\r\n      }\r\n\r\n      const episodes = Object.entries(tmdbEpisodes)\r\n        .map(([numStr, { name, tmdbRating }]) => {\r\n          const num = Number(numStr);\r\n          return {\r\n            episode_number: num,\r\n            name,\r\n            tmdbRating,\r\n            imdbRating: imdbEpisodes[num] ?? null,\r\n          };\r\n        })\r\n        .sort((a, b) => a.episode_number - b.episode_number);\r\n\r\n      seasons.push({\r\n        season_number: s.season_number,\r\n        name: s.name,\r\n        episodes,\r\n      });\r\n    }\r\n\r\n    return NextResponse.json({\r\n      tmdbId: details.id,\r\n      name: details.name,\r\n      first_air_date: details.first_air_date,\r\n      poster_path: details.poster_path ?? null,\r\n      imdb_id,\r\n      seasons,\r\n    });\r\n  } catch (e) {\r\n    return NextResponse.json({ error: e.message || 'Error' }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}