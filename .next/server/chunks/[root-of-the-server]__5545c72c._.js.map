{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 6, "column": 0}, "map": {"version":3,"sources":[],"names":[],"mappings":"","debugId":null}},
    {"offset": {"line": 52, "column": 0}, "map": {"version":3,"sources":["file://E%3A/ASNPORTS/PELICULAS/The%20Show%20Verse/the-show-verse/src/app/api/tv/%5Bid%5D/ratings/route.js"],"sourcesContent":["// /src/app/api/tv/[id]/ratings/route.js\r\nexport const dynamic = 'force-dynamic';\r\n\r\nconst TMDB_BASE = 'https://api.themoviedb.org/3';\r\nconst OMDB_BASE  = 'https://www.omdbapi.com/';\r\n\r\nconst CACHE_TTL_MS = 1000 * 60 * 10; // 10 min\r\nconst cache = new Map();\r\nconst getCache = (k) => {\r\n  const v = cache.get(k);\r\n  if (!v) return null;\r\n  if (Date.now() - v.t > CACHE_TTL_MS) { cache.delete(k); return null; }\r\n  return v.d;\r\n};\r\nconst setCache = (k, d) => cache.set(k, { d, t: Date.now() });\r\n\r\nconst sleep = (ms)=>new Promise(r=>setTimeout(r,ms));\r\nasync function tmdb(path, params = {}) {\r\n  const apiKey = process.env.NEXT_PUBLIC_TMDB_API_KEY;\r\n  if (!apiKey) throw new Error('Falta NEXT_PUBLIC_TMDB_API_KEY');\r\n  const url = new URL(`${TMDB_BASE}${path}`);\r\n  url.searchParams.set('api_key', apiKey);\r\n  url.searchParams.set('language', 'en-US');\r\n  for (const [k,v] of Object.entries(params)) if (v!=null) url.searchParams.set(k, String(v));\r\n  const res = await fetch(url, { next:{ revalidate:300 } });\r\n  if (!res.ok) throw new Error(`TMDb ${res.status}: ${await res.text()}`);\r\n  return res.json();\r\n}\r\nasync function omdb(params = {}, { retries=2, backoff=500 } = {}) {\r\n  const apiKey = process.env.OMDB_API_KEY;\r\n  if (!apiKey) throw new Error('Falta OMDB_API_KEY');\r\n  const url = new URL(OMDB_BASE);\r\n  url.searchParams.set('apikey', apiKey);\r\n  for (const [k,v] of Object.entries(params)) if (v!=null) url.searchParams.set(k, String(v));\r\n\r\n  for (let i=0;i<=retries;i++){\r\n    const res = await fetch(url, { next:{ revalidate:120 } });\r\n    let json=null; try{ json = await res.json(); }catch{}\r\n    const limited = json?.Error && /limit/i.test(json.Error);\r\n    if (res.ok && json && json.Response !== 'False') return json;\r\n    if (i<retries && limited) { await sleep(backoff*(i+1)); continue; }\r\n    return json || { Response:'False', Error:`HTTP ${res.status}` };\r\n  }\r\n}\r\n\r\nconst parseVotes = (x)=>{\r\n  if (x==null) return null;\r\n  if (typeof x==='number') return x;\r\n  if (typeof x==='string') {\r\n    const n = Number(x.replaceAll(',','').trim());\r\n    return Number.isFinite(n) ? n : null;\r\n  }\r\n  return null;\r\n};\r\n\r\nexport async function GET(req, ctx) {\r\n  const { id } = await ctx.params; // Next 15\r\n  try {\r\n    const { searchParams } = new URL(req.url);\r\n    const excludeSpecials = searchParams.get('excludeSpecials') === 'true';\r\n\r\n    const cacheKey = `fast:${id}:${excludeSpecials?1:0}`;\r\n    const hit = getCache(cacheKey);\r\n    if (hit) return Response.json(hit);\r\n\r\n    // Serie + imdb_id\r\n    const [details, ext] = await Promise.all([\r\n      tmdb(`/tv/${id}`),\r\n      tmdb(`/tv/${id}/external_ids`),\r\n    ]);\r\n    const imdbSeriesId = ext?.imdb_id || null;\r\n\r\n    const seasonsMeta = Array.isArray(details.seasons) ? details.seasons : [];\r\n    const seasons = [];\r\n    // Carga en paralelo: TMDb season + OMDb season (si hay imdb id)\r\n    await Promise.all(seasonsMeta.map(async (s) => {\r\n      if (excludeSpecials && s.season_number === 0) return;\r\n\r\n      const [tmdbSeason, omdbSeason] = await Promise.all([\r\n        tmdb(`/tv/${id}/season/${s.season_number}`),\r\n        imdbSeriesId ? omdb({ i: imdbSeriesId, Season: s.season_number }) : Promise.resolve(null),\r\n      ]);\r\n\r\n      // Mapa rápido imdbRating por nº de episodio (OMDb Season)\r\n      const imdbMap = {};\r\n      if (omdbSeason?.Episodes) {\r\n        for (const e of omdbSeason.Episodes) {\r\n          const n = Number(e.Episode);\r\n          const r = e?.imdbRating && e.imdbRating !== 'N/A' ? Number(e.imdbRating) : null;\r\n          imdbMap[n] = Number.isFinite(r) ? r : null;\r\n        }\r\n      }\r\n\r\n      const episodes = (tmdbSeason.episodes || []).map(ep => ({\r\n        episode_number: ep.episode_number,\r\n        name: ep.name,\r\n        tmdbRating: typeof ep.vote_average === 'number' ? ep.vote_average : null,\r\n        tmdbVotes: parseVotes(ep.vote_count),\r\n        imdbRating: imdbMap[ep.episode_number] ?? null, // ⚡️ instantáneo\r\n        imdbVotes: null,                                // se piden a demanda\r\n      })).sort((a,b)=>a.episode_number-b.episode_number);\r\n\r\n      seasons.push({ season_number: s.season_number, name: s.name, episodes });\r\n    }));\r\n\r\n    seasons.sort((a,b)=>a.season_number-b.season_number);\r\n\r\n    const payload = {\r\n      tmdbId: details.id,\r\n      name: details.name,\r\n      first_air_date: details.first_air_date,\r\n      poster_path: details.poster_path ?? null,\r\n      imdb_id: imdbSeriesId,\r\n      seasons,\r\n    };\r\n\r\n    setCache(cacheKey, payload);\r\n    return Response.json(payload);\r\n  } catch (e) {\r\n    return Response.json({ error: e.message || 'Error' }, { status: 500 });\r\n  }\r\n}\r\n"],"names":[],"mappings":"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","debugId":null}}]
}